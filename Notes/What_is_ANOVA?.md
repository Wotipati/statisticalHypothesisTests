# What is ANOVA?
分散分析(<u>An</u>alysis <u>o</u>f <u>va</u>riance, ANOVA)について
- **「ある要因が実験結果に影響を与えたかどうか（=要因の効果があったかどうか）」** を判定する手法
- 「データ全体の変動」を「注目している要因の差による変動(要因変動)」と「誤差変動」に分解し，それぞれの分散の大きさを比較する（F値を計算する）ことにより検定を行う
- 要因の数によって以下のように区別して呼ばれる
  - 1要因の場合: 一元配置分散分析 (One-way ANOVA)
  - 2要因の場合: 二元配置分散分析 (Two-way ANOVA)
  - 3要因以上の場合: 多元配置分散分析 (n-way ANOVA)
- 対応ありか否かによって以下のように分類される
  - 対応なし: 要因分散分析(Factrial ANOVA, "ANOVA"のみで表記される場合もコッチ)
  - 対応あり: 反復測定分散分析(Repeated-measures ANOVA))

## 目次
- [対応なし一元配置分散分析](#対応なし一元配置分散分析)
- [対応あり一元配置分散分析](#対応あり一元配置分散分析)
- [多元配置分散分析](#多元配置分散分析)

---

## 対応なし一元配置分散分析
例) 施肥の有無が穀物の収量に影響を及ぼすか調査 (pythonスクリプトは[こちら](https://github.com/Wotipati/statisticalHypothesisTests/tree/master/ANOVA/One-way-Anova)
)
- 要因: 施肥
- 誤差: 日当たり、水はけ、土壌など


#### 収集したデータ

**表1 施肥量と収量の関係**  

||水準1<br>(施肥量0kg)|水準2<br>(施肥量10kg)|水準3<br>(施肥量20kg)|水準4<br>(施肥量30kg)||
|:-----|:-------------|:---------------|:--------------|:--------------|:--------------|
||9 |13|17|16||
||11|12|16|17||
||10|14|15|18||
|平均|10|13|16|17|総平均: 14|

---

#### データの分離
以下の①~③にしたがって、データ全体の変動を、注目している要因による変動(要因変動)と誤差による変動(誤差変動)の和に分離する
#### ①全体の変動
- データ全体の変動は**各値と総平均の差**で捉える
- 総変動と呼ぶ  

**表2 総変動(各値-総平均)**  

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-5|-1|3|2|
|-3|-2|2|3|
|-4|0|1|4|


#### ②目的となる要因の効果による変動
- 要因による変動は、**各水準の平均と総平均の差**で捉える
- **群間変動**と呼ばれる
- 誤差による影響がなければ、同じ群（同じ水準）内では全て同じ値になるはず、という考え

**表3 群間変動(群平均-総平均)**  

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-4  |-1  |2    |3|
|-4  |-1  |2    |3|
|-4  |-1  |2    |3|


#### ③誤差効果による変動
- 注目している要因以外の要因による変動は、誤差効果による変動とし、**各値と各群の平均の差**で捉える
- **郡内変動**と呼ばれる

**表4 誤差変動(各値-群平均)**

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-1  |0  |1    |-1|
|1  |-1  |0    |0|
|0  |1  |-1    |1|

---

#### 分散分析の検定
- 要因変動と誤差変動の分散を用いてF検定を行う
  - 帰無仮説H<sub>0</sub>: 要因効果と誤差効果との間に差はない
  - 対立仮説H<sub>1</sub>: 要因効果と誤差効果との間に差はある
- `F値 = (群間変動の分散)/(誤差変動)`
  - `F値>1`の場合
    - 誤差による変動より、要因による変動が大きいため、「要因効果がある」となる
  - `F値<=1`の場合
    - 要因変動は誤差変動に埋もれてしまうため、「要因効果がない」となる

#### 例におけるF検定
- 群間変動
  - 偏差平方和 = 90
  - 自由度 = 3
  - 分散 = 30
- 誤差変動
  - 偏差平方和 = 8
  - 自由度 = 8
  - 分散 = 1
- F値 = 30  
- p値 = 0.000105653  
- 帰無仮説は棄却され、対立仮説が採択された


---

## 対応あり一元配置分散分析
- ブロック（同じ対応を持った標本の集合、区画ともいう）という要因（ブロック因子）による特性の差を分離することができる
- 以下の例で示すように総変動を`群間変動 + 標本間変動 + 誤差変動`に分離する
- scipyに実装されていないため、スクリプトはなし
- `pyvttbl`モジュールを使うと計算可能(と[思われる](https://www.marsja.se/repeated-measures-anova-using-python/))

例) 施肥の有無が穀物の収量に影響を及ぼすか調査(対応あり)
- 同じ区画で時期を変えて異なる施肥量でデータを収集した場合、**区画ごとの対応があるデータ**となる

||水準1<br>(施肥量0kg)|水準2<br>(施肥量10kg)|水準3<br>(施肥量20kg)|水準4<br>(施肥量30kg)|平均|
|:-----|:-------------|:---------------|:--------------|:--------------|:--------------|
|**第一区画**|9 |13|17|16|**13.75**|
|**第二区画**|11|12|16|17|**14.00**|
|**第三区画**|10|14|15|18|**14.25**|
|平均|10|13|16|17|総平均: 14|

---

### データの分離

#### ①総変動
**表2 総変動(各値-総平均)**  

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-5|-1|3|2|
|-3|-2|2|3|
|-4|0|1|4|

#### ②群間変動
**表3 群間変動(群平均-総平均)**  

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-4  |-1  |2    |3|
|-4  |-1  |2    |3|
|-4  |-1  |2    |3|

#### **③標本間変動**
- 対応ありの時のみ分離可能な変動値
- `標本平均 - 総平均` で求める

**表5 標本間変動(標本平均-総平均)**  

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-0.25  |-0.25  |-0.25  |-0.25|
|0  |0  |0    |0|
|0.25  |0.25  |0.25  |0.25|


#### ④誤差変動
- `郡内平均 - 標本間平均`で求める
  - `郡内平均 = 各値 - 群平均`
  - `標本間平均 = 標本平均 - 総平均`で求める

**表5 標本間変動((各値-群平均)-(標本平均-総平均))**  

|水準1|水準2|水準3|水準4|
|:---|:---|:----|:---|
|-0.75  |0.25  |1.25  |-0.75|
|-1  |-1  |0    |0|
|-0.25  |0.75  |-1.25  |0.75|


---

### 検定
- `F値 = (群間変動の分散)/(誤差変動)`
- この時`誤差変動 = 郡内変動 - 標本間変動`となる

#### 例におけるF検定
- 群間変動
  - 偏差平方和 = 90
  - 自由度 = 3
  - 分散 = 30
- 標本間変動
  - 偏差平方和 = 0.5
  - 自由度 = 2
  - 分散 = 0.25
- 誤差変動
  - 偏差平方和 = 7.5
  - 自由度 = 6
  - 分散 = 1.25
- F値 = 24  
- p値 = 0.00010  
- 帰無仮説は棄却され、対立仮説が採択された


---

## 多元配置分散分析
- 要因が二つ以上ある場合
- 複数の因子による相乗効果(交互作用)があるかどうか判定することが可能
- [参考サイト](https://bellcurve.jp/statistics/course/10059.html)

例)
||因子B(0kg)|因子B<br>(10kg)|因子B<br>(20kg)|因子B<br>(30kg)||
|:-----|:-------------|:---------------|:--------------|:--------------|:--------------|
|因子Aあり|14.5|16.5|17.8|18.1||
|因子Aあり|15.1|16.1|19|20.2||
|因子Aあり|14.1|15|15.2|17.2||
|平均|14.57|15.87|17.33|18.50|因子Aあり平均: 16.57|
|因子Aなし|16.2|18.6|21.7|23.6||
|因子Aなし|15.3|16.9|20.5|24.9||
|因子Aなし|17.5|18.6|19.4|25.5|因子Aなし平均: 18.89|
|平均|16.33|18.03|20.53|24.67|総平均: 18.23|

#### ①総変動
- `各値 - 総平均`

#### ②因子Aの群間変動
- `因子Aの各水準の平均 - 総平均`

#### ③因子Bの群間変動
- `因子Bの各水準の平均 - 総平均`

#### ④因子A×因子B(交互作用)による変動
- 平方和は`(因子A×因子B(3要素)の平均 - 総平均)の平方和 - 因子Aの群間変動の平方和 - 因子Bの群間変動の平方和`

#### ⑤誤差
- 平方和は`全体の平方和-因子Aの群間変動の平方和 - 因子Bの群間変動の平方和 - 交互作用の変動の平方和`
